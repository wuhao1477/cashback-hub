<!-- 2e1322ee-c84f-4c43-8253-8cedc4ab96a1 f7bc9de8-ddf6-4c39-bbc5-f26ac44838d4 -->
# 数据适配器架构设计

## 目标

创建一个共享的数据适配器层（`packages/adapters`），将不同平台和服务商的原始 API 响应转换为统一的标准数据结构，实现：

- 前后端共享数据转换逻辑
- 平台/服务商变更时只需修改适配器
- 支持未来扩展新的服务商和平台

## 架构设计

### 1. 包结构

```
packages/
  adapters/
    src/
      types/
        standard.ts          # 标准数据结构定义
        raw.ts               # 原始数据类型定义
        adapter.ts           # 适配器接口定义
      adapters/
        ztk/                 # 折淘客服务商适配器
          index.ts           # ZTK 适配器工厂
          meituan.ts         # 美团平台适配器
          eleme.ts           # 饿了么平台适配器
          types.ts           # ZTK 原始数据类型
        official/            # 官方 API 适配器（未来扩展）
      utils/
        formatter.ts         # 数据格式化工具（佣金、日期等）
        validator.ts         # 数据验证工具
      index.ts               # 统一导出
    package.json
    tsconfig.json
```

### 2. 核心接口设计

#### 标准数据结构（Standard Activity Model）

- `StandardActivitySummary`: 活动列表项标准结构
- `StandardActivityDetail`: 活动详情标准结构
- `StandardLinkVariant`: 链接变体标准结构
- `StandardQrCode`: 二维码标准结构

#### 适配器接口

```typescript
interface ActivityAdapter {
  normalizeList(raw: RawData): StandardActivitySummary[]
  normalizeDetail(raw: RawData): StandardActivityDetail
  extractLinkVariants(raw: RawData): StandardLinkVariant[]
  extractQrCodes(raw: RawData): StandardQrCode[]
}
```

### 3. 实现策略

#### 3.1 服务商层适配器（Provider Adapters）

- `ZtkAdapter`: 折淘客服务商适配器基类
  - 处理折淘客通用的响应结构解析
  - 提供通用的字段提取逻辑
- 未来可扩展：`OfficialAdapter`（官方 API）、`OtherProviderAdapter`（其他服务商）

#### 3.2 平台层适配器（Platform Adapters）

- `ZtkMeituanAdapter`: 美团平台在折淘客下的适配
- `ZtkElemeAdapter`: 饿了么平台在折淘客下的适配
- 每个平台适配器实现具体的字段映射逻辑

#### 3.3 数据转换流程

```
原始 API 响应 
  → 服务商适配器（解析响应结构）
    → 平台适配器（字段映射）
      → 标准数据结构
        → 格式化工具（可选，或由前后端各自处理）
```

### 4. 迁移计划

#### 阶段 1: 创建共享包

- 创建 `packages/adapters` 目录结构
- 定义标准数据结构和适配器接口
- 配置 TypeScript 和构建工具

#### 阶段 2: 实现 ZTK 适配器

- 实现 `ZtkMeituanAdapter`（迁移前端 `meituan.ts` 中的转换逻辑）
- 实现 `ZtkElemeAdapter`（迁移前端 `eleme.ts` 中的转换逻辑）
- 提取通用的格式化工具函数

#### 阶段 3: 前后端集成

- 前端：修改 `MeituanPlatform` 和 `ElemePlatform`，使用适配器
- 后端：修改 `MeituanPlatformClient` 和 `ElemePlatformClient`，使用适配器
- 移除前后端中重复的转换逻辑

#### 阶段 4: 测试与验证

- 确保前后端功能正常
- 验证数据转换准确性
- 性能测试

## 关键文件

### 需要创建的文件

- `packages/adapters/src/types/standard.ts` - 标准数据结构
- `packages/adapters/src/types/adapter.ts` - 适配器接口
- `packages/adapters/src/adapters/ztk/meituan.ts` - 美团适配器
- `packages/adapters/src/adapters/ztk/eleme.ts` - 饿了么适配器
- `packages/adapters/src/utils/formatter.ts` - 格式化工具（从前后端提取）

### 需要修改的文件

- `apps/frontend/src/services/platforms/meituan.ts` - 使用适配器
- `apps/frontend/src/services/platforms/eleme.ts` - 使用适配器
- `apps/frontend/src/services/platforms/base.ts` - 移除转换逻辑
- `apps/backend/src/services/platforms/meituan.ts` - 使用适配器
- `apps/backend/src/services/platforms/eleme.ts` - 使用适配器
- `apps/backend/src/services/platforms/base.ts` - 移除转换逻辑
- `package.json` - 添加 workspace 依赖
- `pnpm-workspace.yaml` - 已包含 packages/*，无需修改

## 设计原则

1. **单一职责**: 适配器只负责数据转换，不处理网络请求
2. **可扩展性**: 通过接口和工厂模式支持新服务商和平台
3. **类型安全**: 完整的 TypeScript 类型定义
4. **向后兼容**: 保持现有的 `ActivityDetail` 等类型不变，适配器输出匹配现有类型
5. **无副作用**: 适配器函数应该是纯函数，不修改输入数据

## 注意事项

- 格式化逻辑（如 `formatCommission`、`formatDateRange`）可以保留在前后端各自的 utils 中，或提取到共享包中
- 适配器应该处理所有字段映射，包括容错逻辑（多种字段名尝试）
- 保持现有的 `ActivityDetail` 类型定义不变，确保页面代码无需修改

### To-dos

- [x] 创建 packages/adapters 目录结构，配置 package.json 和 tsconfig.json
- [x] 定义标准数据结构类型（StandardActivitySummary, StandardActivityDetail 等）
- [x] 定义适配器接口和基类，设计适配器工厂模式
- [x] 提取格式化工具函数到共享包（佣金、日期格式化等）
- [x] 实现 ZTK 美团平台适配器，迁移前端 meituan.ts 中的转换逻辑
- [x] 实现 ZTK 饿了么平台适配器，迁移前端 eleme.ts 中的转换逻辑
- [x] 修改前端平台服务，使用适配器替换现有转换逻辑
- [x] 修改后端平台服务，使用适配器替换现有转换逻辑
- [x] 测试前后端功能，验证数据转换正确性和性能
